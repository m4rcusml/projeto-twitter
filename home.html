<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UFT-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitter 2</title>
    <link rel="stylesheet" href="css/geral.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</head>

<body>
    <header>
        <nav class="menu-box">
            <div class="menu-lista">
                <a href="home.html" class="menu-button">
                    <div class="menu-button-content">
                        <span class="menu-button-content-icon material-symbols-outlined">
                            home
                        </span>
                        <span class="menu-button-content-text">
                            Início
                        </span>
                    </div>
                </a>
                <a href="#" class="menu-button">
                    <div class="menu-button-content">
                        <span class="menu-button-content-icon material-symbols-outlined">
                            tag
                        </span>
                        <span class="menu-button-content-text">
                            Explorar
                        </span>
                    </div>
                </a>
                <a href="#" class="menu-button">
                    <div class="menu-button-content">
                        <span class="menu-button-content-icon material-symbols-outlined">
                            person
                        </span>
                        <span class="menu-button-content-text">
                            Perfil
                        </span>
                    </div>
                </a>
            </div>
            <button class="menu-conta-button">
                <img src="imgs/profile-image.jpg" class="profile-image">
                <div class="profile-info">
                    <span class="nickname">ML</span>
                    <span class="username">@m4rcusml</span>
                </div>
                <!-- Adicionar os ... -->
            </button>
        </nav>
    </header>
    <main>
        <div class="topo-main">
            <h2 class="titulo-main">Página Inicial</h2>
            <div class="qual-timeline">
                <button id="para-voce">
                    Para você
                </button>
                <button id="seguindo">
                    Seguindo
                </button>
            </div>
        </div>
        <div class="post-container">
            <img src="imgs/profile-image.jpg" class="profile-image">
            <div class="post-area">
                <div id="post-text" contenteditable="true"></div>
                <div class="nav-post">
                    <div class="nav-post-buttons">

                    </div>
                    <button class="button-post-action" disabled="disabled">Postar</button>
                </div>
            </div>
        </div>
    </main>
    <aside>
        <p style="padding: 1em;">Lorem ipsum dolor sit amet consectetur adipisicing elit. Dolorum voluptate,
            pariatur molestias reprehenderit cum corporis asperiores! Itaque sint quis maiores?
            Maiores praesentium nesciunt ducimus est minima, dolorum totam velit cupiditate.</p>
    </aside>
    <script src="scripts/index.js"></script>

    <script>

        const textoParaPostar = document.querySelector('#post-text')
        const botaoParaPostar = document.querySelector('.button-post-action')
        const limiteCaracteres = 100;

        textoParaPostar.addEventListener('input', digitando);
        textoParaPostar.addEventListener('paste', colandoTexto);

        function digitando() {
            const savedSelection = saveSelection(textoParaPostar);

            if (textoParaPostar.textContent.trim().length > 0 && /\w/.test(textoParaPostar.textContent)) {
                botaoParaPostar.disabled = false;
            } else {
                botaoParaPostar.disabled = true;
            }

            verLimiteCaracteres();

            restoreSelection(textoParaPostar, savedSelection);
        }

        function colandoTexto(e) {
            e.preventDefault();
            const text = e.clipboardData.getData('text/plain');
            document.execCommand('insertText', false, text);
            setTimeout(digitando, 0);
        }

        function saveSelection(containerEl) {
            const range = window.getSelection().getRangeAt(0);
            const preSelectionRange = range.cloneRange();
            preSelectionRange.selectNodeContents(containerEl);
            preSelectionRange.setEnd(range.startContainer, range.startOffset);
            const start = preSelectionRange.toString().length;

            return {
                start: start
            };
        }

        function restoreSelection(containerEl, savedSelection) {
            let charIndex = 0;
            const range = document.createRange();
            const nodeStack = [containerEl];
            let node, foundStart = false, stop = false;

            range.setStart(containerEl, 0);
            range.collapse(true);

            while (!stop && (node = nodeStack.pop())) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const nextCharIndex = charIndex + node.length;
                    if (!foundStart && savedSelection.start >= charIndex && savedSelection.start <= nextCharIndex) {
                        range.setStart(node, savedSelection.start - charIndex);
                        foundStart = true;
                    }
                    if (foundStart && savedSelection.start + limiteCaracteres <= nextCharIndex) {
                        range.setEnd(node, savedSelection.start + limiteCaracteres - charIndex);
                        stop = true;
                    }
                    charIndex = nextCharIndex;
                } else {
                    let i = node.childNodes.length;
                    while (i--) {
                        nodeStack.push(node.childNodes[i]);
                    }
                }
            }

            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }


        function verLimiteCaracteres() {
            const texto = textoParaPostar.textContent;

            if (texto.length > limiteCaracteres) {
                const textoFormatado = texto.slice(0, limiteCaracteres);
                const textoExcedente = texto.slice(limiteCaracteres);

                const novoTexto = `<span style="background-color: red;">${textoExcedente}</span>`;

                textoParaPostar.innerHTML = textoFormatado + novoTexto + '&zwnj;';
            } else {
                textoParaPostar.innerHTML = texto;
            }
        }


        // textoParaPostar.addEventListener('input', digitando);
        // textoParaPostar.addEventListener('paste', colandoTexto);

        // function digitando() {
        //     const savedSelection = saveSelection(textoParaPostar);

        //     if (textoParaPostar.textContent.trim().length > 0 && /\w/.test(textoParaPostar.textContent)) {
        //         botaoParaPostar.disabled = false;
        //     } else {
        //         botaoParaPostar.disabled = true;
        //     }

        //     verLimiteCaracteres();

        //     restoreSelection(textoParaPostar, savedSelection);
        // }

        // function colandoTexto(e) {
        //     e.preventDefault();
        //     const text = e.clipboardData.getData('text/plain');
        //     document.execCommand('insertText', false, text);
        //     setTimeout(digitando, 0);
        // }

        // function saveSelection(containerEl) {
        //     const range = window.getSelection().getRangeAt(0);
        //     const preSelectionRange = range.cloneRange();
        //     preSelectionRange.selectNodeContents(containerEl);
        //     preSelectionRange.setEnd(range.startContainer, range.startOffset);
        //     const start = preSelectionRange.toString().length;

        //     return {
        //         start: start
        //     };
        // }

        // function restoreSelection(containerEl, savedSelection) {
        //     const charIndex = 0;
        //     const range = document.createRange();
        //     range.setStart(containerEl.firstChild, savedSelection.start + charIndex);
        //     range.collapse(true);
        //     const selection = window.getSelection();
        //     selection.removeAllRanges();
        //     selection.addRange(range);
        // }

        // function verLimiteCaracteres() {
        //     const texto = textoParaPostar.textContent;
        //     const limiteCaracteres = 100;

        //     if (texto.length > limiteCaracteres) {
        //         const textoFormatado = texto.slice(0, limiteCaracteres);
        //         const textoExcedente = texto.slice(limiteCaracteres);

        //         const novoTexto = `<span style="background-color: red;">${textoExcedente}</span>`;

        //         textoParaPostar.innerHTML = textoFormatado + novoTexto + '&zwnj;';
        //     } else {
        //         textoParaPostar.innerHTML = texto;
        //     }
        // }

    </script>
</body>

</html>